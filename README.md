<div align= "center">
    <img src="https://capsule-render.vercel.app/api?type=egg&color=0:644f4f,100:f8f7f7&height=180&text=Hello%20World!%20I'm%20jinsoon&animation=twinkling&fontColor=4b4848&fontSize=40" />
    </div>
    <div style="text-align: left;"> 
    <h2 style="border-bottom: 1px solid #d8dee4; color: #282d33;"> 안녕하세요! </h2>  
    <div style="font-weight: 700; font-size: 15px; text-align: left; color: #282d33;">  <li> 저는 항상 성장하는 개발자를 희망합니다. 저는 배우는 것이 즐겁습니다. </div> 
    </div>
    <div style="text-align: left;">
    <h2 style="border-bottom: 1px solid #d8dee4; color: #282d33;"> 🛠️ Tech Stacks </h2> <br> 
    <div style="margin: ; text-align: left;" "text-align: left;">
	  <img src="https://img.shields.io/badge/Java-007396?style=plastic&logo=Java&logoColor=white">
	  <img src="https://img.shields.io/badge/Spring Boot-6DB33F?style=plastic&logo=Spring Boot&logoColor=white">
          <img src="https://img.shields.io/badge/AWS-232F3E?style=plastic&logo=Amazon%20AWS&logoColor=white">
	  <img src="https://img.shields.io/badge/JSP-007396?style=plastic&logo=java&logoColor=white">
	    <br/>
	    <img src="https://img.shields.io/badge/MySQL-4479A1?style=plastic&logo=MySQL&logoColor=white">
	    <img src="https://img.shields.io/badge/Oracle-F80000?style=plastic&logo=Oracle&logoColor=white">
	    <img src="https://img.shields.io/badge/Firebase-FFCA28?style=plastic&logo=Firebase&logoColor=white">
          <br/><img src="https://img.shields.io/badge/HTML5-E34F26?style=plastic&logo=HTML5&logoColor=white">
	     <img src="https://img.shields.io/badge/CSS3-1572B6?style=plastic&logo=CSS3&logoColor=white">
	    <img src="https://img.shields.io/badge/Javascript-F7DF1E?style=plastic&logo=Javascript&logoColor=white">
          <img src="https://img.shields.io/badge/jQuery-0769AD?style=plastic&logo=jQuery&logoColor=white">
	    <img src="https://img.shields.io/badge/Vue.js-4FC08D?style=plastic&logo=Vue.js&logoColor=white">
	    <img src="https://img.shields.io/badge/Ajax-0095D5?style=plastic&logo=javascript&logoColor=white">
          <br/>
	    <img src="https://img.shields.io/badge/React-61DAFB?style=plastic&logo=React&logoColor=white">
	    <img src="https://img.shields.io/badge/Node.js-339933?style=plastic&logo=Node.js&logoColor=white">
	    <img src="https://img.shields.io/badge/Express-000000?style=plastic&logo=Express&logoColor=white">
          <br/>
          <img src="https://img.shields.io/badge/Apache Tomcat-F8DC75?style=plastic&logo=Apache Tomcat&logoColor=white">
          <img src="https://img.shields.io/badge/Linux-FCC624?style=plastic&logo=Linux&logoColor=white">
	  <img src="https://img.shields.io/badge/Flutter-02569B?style=plastic&logo=Flutter&logoColor=white">
	  <img src="https://img.shields.io/badge/Dart-0175C2?style=plastic&logo=Dart&logoColor=white">
   	  <img src="https://img.shields.io/badge/C-A8B9CC?style=plastic&logo=C&logoColor=white">
          </div>
    </div>
    <div style="text-align: left;">
	<h2>💡 Portfolio </h2>
	    <div>😎<a style="font-size: 25px;" href="https://bit.ly/3K443HT">포트폴리오</a></div>
    </div>
    <div style="text-align: left;">
	<h2>📝 Projects </h2>
	    <div>🍔<a style="font-size: 25px;" href="https://github.com/lsssssssssssssss/FOOD114">FOOD114</a></div>
	    <div>🥰<a style="font-size: 25px;" href="https://github.com/vvyejivv/wooki.git">WOOKI</a></div>
	    <div>🏃‍♂️<a style="font-size: 25px;" href="https://github.com/lsssssssssssssss/miniProject1">Fitness Shop</a></div>
	    <div>😄<a style="font-size: 25px;" href="https://github.com/lsssssssssssssss/sns_project.git">SNS SITE</a></div>
    </div>
    <div style="text-align: left;">
    <h2 style="border-bottom: 1px solid #d8dee4; color: #282d33;"> 🧑‍💻 Contact me </h2> <br> 
    <div style="text-align: left;"> <a href=https://velog.io/@ekfm8581> <img src="https://img.shields.io/badge/Velog-20C997?style=plastic&logo=Velog&logoColor=white&link=https://velog.io/@ekfm8581"> </a>
         <a href=mailto:ekfm6901@gmail.com> <img src="https://img.shields.io/badge/Gmail-EA4335?style=plastic&logo=Gmail&logoColor=white&link=mailto:ekfm6901@gmail.com"> </a>
          </div>  <br> 
    <div style="text-align: left;"> <a href="https://hits.seeyoufarm.com"> <img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fgithub.com%2Flsssssssssssssss%2F&count_bg=%23000000&title_bg=%23000000&icon=github.svg&icon_color=%23FFFFFF&title=GitHub&edge_flat=false"/></a>
       </div> 
	<br>
        <p>🏆 Baekjoon solved rank 🏆</p>
	
[![Solved.ac Profile](http://mazassumnida.wtf/api/v2/generate_badge?boj=ekfm8581)](https://solved.ac/ekfm8581)
    </div>
    <div style="text-align: left;"> 
    <h2 style="border-bottom: 1px solid #d8dee4; color: #282d33;"> 🏅 Stats </h2> <div style="text-align: left;"> <img src="https://github-readme-stats.vercel.app/api?username=lsssssssssssssss&bg_color=180,00000000,&title_color=000000&text_color=000000"
         /> <img src="https://github-readme-stats.vercel.app/api/top-langs/?username=lsssssssssssssss&layout=compact&bg_color=180,00000000,&title_color=000000&text_color=000000"
           /> </div> 
    <div>
from src.api.dto.AnalyzeTextDTO import ReqAnalyzeText, RspAnalyzeText, DetectInfo
import cv2 as cv
import logging
from pydantic import BaseModel, Field
import src.ObjectDetection.ObjectDetectionMediator as detectMediator
from src.util.load_id_img_valid import IdentificationValidResult, procIdentValid
from src.util.load_yunet import create_Yunet
from src.util.load_txt_blurValid import validTextBlur, ValidTextBlurResult
from src.api.dto.IDScanDTO import ReqIDScan, RspIDScan
from src.util.load_ImageUtil import getImageUtil
import src.OCR.TextReaderMediator as textReaderMediator
import asyncio as asyn
import numpy as np
import os
import sys
import re
import time
import json
from src.decorator.funcIntercepter import observe_process_time

logger = logging.getLogger(__name__)

YUNET = create_Yunet()

FULL_REGEX = re.compile(r'(\d{6})[- ]?(\d{7})')
FRONT_REGEX = re.compile(r'([0-9]{2})(0[1-9]|1[0-2])(0[1-9]|[1,2][0-9]|3[0,1])')
BACK_REGEX = re.compile(r'[0-9]{7}')
ISSUE_DATE_REGEX = re.compile(r'[0-9]{4}[. ]?(0[1-9]|1[0-2])[. ]?(0[1-9]|[1,2][0-9]|3[0,1])')
NATIONALITY_REGEX = re.compile(r'[^A-Z]')


#신분증 자동촬영 프로세스
@observe_process_time
async def textAnalyze(param : ReqAnalyzeText):
    start = time.time_ns()
    """
        이미지에서 신분증을 탐지하고, 신분증영역에서 글씨를 추출한다.
        추출한 정보를 반환한다.
    
    """
    print(f"param :: {param}") 
    
    #TODO : DetectIdentification 참조
    imageUtil = getImageUtil()
    
    #신분증 이미지 불러오기
    img = cv.imread(param.image_path)
    
    #신분증 탐지 모델 실행
    detectResults = detectMediator.detection(img, type='ID')[0]
    
    #이미지 정보 세팅
    imgY, imgX, _ = img.shape
    id_type_list = detectResults.names
    
    #신분증 위치 세팅
    boxes = detectResults.boxes
    boxlist = boxes.xyxy.tolist()
    if 0 == len(boxlist) : 
        return RspAnalyzeText(result='ERROR_01', cropped_img_path='')
    id_type = id_type_list[int(boxes.cls[0])]
    print(f'id_type :: {id_type}')
    logger.info(f'boxes.id_type :: {id_type}' )
    
    x = int(boxlist[0][0])
    y = int(boxlist[0][1])
    w = int(boxlist[0][2])
    h = int(boxlist[0][3])
    
    logger.info(f'boxes.xyxy :::: {boxes.xyxy}' )
    
    marginY_rate = 0.3
    marginX_rate = 0.05
    
    marginY = int(img.shape[0] * marginY_rate)
    marginX = int(img.shape[1] * marginX_rate)

    validPoints = []
    validPoints.append((x,y))
    validPoints.append((x,h))
    validPoints.append((w,y))
    validPoints.append((w,h))
    cropRect = (0, marginY, img.shape[1], img.shape[0]-(marginY+marginY))
    
    # #넓이가 작은경우, 멀리 있는 것으로 판단
    if int(w-x) < int(img.shape[1]*0.67) :
        logger.info(f'TOO FAR ')
        return RspIDScan(result='ERROR_03', cropped_img_path='')
    
    # #좌우 마진이 부족한 경우 -> 너무 가까이 있는 것으로 판단
    if x < int(img.shape[1]*0.05) and w > int(img.shape[1] - int(img.shape[1]*0.05)) :
        logger.info(f'TOO CLOSE ')
        return RspIDScan(result='ERROR_02', cropped_img_path='')
    
    # #좌우 여백 차이가 2배 이상 날 경우, (좌측으로 치우친 경우)
    if int(x * 2) < int(img.shape[1] - w):
        logger.info(f'Too far to the left ')
        return RspIDScan(result='ERROR_04', cropped_img_path='')
    
    # #좌우 여백 차이가 2배 이상 날 경우, (우측으로 치우친 경우)
    if x > int((img.shape[1] - w) * 2):
        logger.info(f'Too far to the right ')
        return RspIDScan(result='ERROR_05', cropped_img_path='')
    
    # #가이드 안에 4점이 없는 경우:
    if chkMargin(cropRect, validPoints) is False:
        logger.info(f'chkMargin(cropRect, validPoints) is {chkMargin(cropRect, validPoints)} ')
        return RspIDScan(result='ERROR_05', cropped_img_path='')
    
    logger.info(f'image crop :: {cropRect}')
    cropped_img = img[cropRect[1]:cropRect[1]+cropRect[3], cropRect[0]:cropRect[0]+cropRect[2]]
    
    qr_code_yn = 'N'
    if id_type.upper() == 'ARC_QR':
        logger.info(f'new ARC :: QR_CODE_READ')
        qr_code_yn = 'Y'
    
    #TODO : paddleOCR 인식 추가
    ocr_data = ''
    
    logger.info(f"DetectIdentification ocr_flag : {param.ocr_flag}")
    if param.ocr_flag == 'Y':  
        try:
            mask = np.zeros_like(img, np.uint8)

            maskXY = detectResults[0].masks.xy[0]
            c = maskXY.astype(np.int32)
            c = c.reshape((-1, 1, 2))
            mask = cv.fillPoly(mask, [c], color=(255,255,255))
            k = cv.getStructuringElement(cv.MORPH_RECT, (7,7))
            erosion = cv.erode(mask, k, iterations=40)
            mask = cv.dilate(erosion, k, iterations=40)
            mask = np.where((mask == False), 200, 0).astype("uint8")
            # mask = mask[cropRect[1]:cropRect[1]+cropRect[3], cropRect[0]:cropRect[0]+cropRect[2]]
            #cv.imwrite('test_data/mask_debug.jpg', mask)
            corners =  imageUtil.getRectPoints(mask, debug=False)
            transform_img = imageUtil.transformImage(image=img, corners=corners, type="front")
            #transform_img = imageUtil.histogram_equalize_color(transform_img)
            #cv.imwrite('test_data/transform_debug.jpg', transform_img)
    
            if id_type.upper() == 'ARC' or id_type.upper() == 'ARC_QR':
                lang = 'en'
            else:
                lang = 'korean'
    
            height, width = transform_img.shape[:2]
            max_width = 720

            if width > max_width:
                # 새로운 너비와 높이를 계산합니다.
                logger.info(f"resize Image :: {transform_img.shape}")
                new_height = int(max_width * height / width)
                new_size = (max_width, new_height)
                
                transform_img = cv.resize(transform_img, new_size, interpolation=cv.INTER_LANCZOS4)

                
            text_lines = textReaderMediator.doOcr(transform_img, lang=lang)
    
            ocr_data = await asyn.create_task(text_analyze(text_lines, id_type, transform_img.shape[:2]))

            if not ocr_data['result']:
                logger.info(f'ocr_data fail. ocr_data is {ocr_data} ')
                return RspAnalyzeText(result='ERROR_05', cropped_img_path='')


            ocr_data = json.dumps(ocr_data, ensure_ascii=False)

        except Exception as e:
            logger.error(f"Exception e :: {e}")
            raise e        

    #이미지 저장
    img_path=param.image_path.replace('.jpg','_cropped.jpg')
    cv.imwrite(img_path, cropped_img)
    
    return RspAnalyzeText(result_code='00'
                          , refer_no=param.refer_no
                          , cropped_img_path=img_path
                          , qr_code_yn='N'
                          , detect_infos = [ocr_data]
                          , process_time = time.time_ns() - start
                          , ocr_data=ocr_data)
    
@observe_process_time
async def text_analyze(texts=None, type='arc', shape=None):   
    height, width = shape

    social_license_points_percentage = [
        (0.295, 0.3073),  # 이름 위치 (10%, 20%)
        (0.3014, 0.4257),  # 주민등록번호 위치 (10%, 30%)
        (0.5159, 0.791)   # 발급일자 위치 (10%, 40%)
    ]

    drive_license_points_percentage = [
        (0.4535, 0.3086),  # 이름 위치 (10%, 20%)
        (0.5442, 0.379),  # 주민등록번호 위치 (10%, 30%)
        (0.6659, 0.9077)   # 발급일자 위치 (10%, 40%)
    ]


    print(texts)

    label = [
        'name', 'license_number', 'issued_date'
    ]
    #TODO : 신분증 OCR 결과 분석

    response = {
        'result' : False
        , 'name' : ''
        , 'issued_date' : ''
        , 'license_number' : ''
        , 'id_type' : type
    }

    if type.upper() == 'ARC' or type.upper() == 'ARC_QR':
        print(f'type start :: {type}')
        detections = []
        
        for text in texts:
            detections.append((text["points"], text["text"], text["conf"]))
            

        front_point = None
        
        #외국인 등록번호 확인
        personalNumber = list(filter(lambda x : isPersonalNumber(x[1]), detections))
        logger.info(f'personalNumber :: {personalNumber}')
        if personalNumber is None or len(personalNumber) == 0:
            personalNumber_front = list(filter(lambda x : isPersonalNumberFront(x[1]) , detections))
            personalNumber_back = list(filter(lambda x : isPersonalNumberBack(x[1]), detections))
            if personalNumber_front is None or len(personalNumber_front) == 0:
                # return RspIdentOcr(response_status="ERROR", response_message="Not Found DocId", result_values=str(response) ,plain_text=str(plain_text_list), result_path=param.image_path.replace('.jpg', '_afterOCR.jpg'))
                return response
            if personalNumber_back is None or len(personalNumber_back) == 0:
                # return RspIdentOcr(response_status="ERROR", response_message="Not Found DocId", result_values=str(response) ,plain_text=str(plain_text_list), result_path=param.image_path.replace('.jpg', '_afterOCR.jpg'))
                return response
            
            
            front_point = personalNumber_front[0][0][1]
            personalNumber = FRONT_REGEX.search(personalNumber_front[0]).group() + '-' + BACK_REGEX.search(personalNumber_back[0]).group()
            
            reference_point = find_reference_point(personalNumber_front)
        


        if front_point is None:
            reference_point = find_reference_point(personalNumber)

            front_point = [int((personalNumber[0][0][1][0] + personalNumber[0][0][0][0]) / 2), personalNumber[0][0][2][1]]
            personalNumber = FRONT_REGEX.search(personalNumber[0][1]).group() + '-' + BACK_REGEX.search(personalNumber[0][1]).group()
        
        
        #발급일자 정규식 확인
        issueDate = list(filter(lambda x : isIssueDate(x[1]), detections))
        reference_point = reference_point + (issueDate[0][0][0][1],)
        
        if issueDate is None or len(issueDate) == 0:
            # return RspIdentOcr(response_status="ERROR", response_message="Not Found issueDate", result_values=str(response) ,plain_text=str(plain_text_list), result_path=param.image_path.replace('.jpg', '_afterOCR.jpg'))
            return response
        print(f'issueDate :: {issueDate}')
        
        logger.info(f'reference_point :: {reference_point}')
        logger.info(f'detections :: {detections}')
        logger.info(f'front_point :: {front_point}')
        
        print(f'reference_point :: {reference_point}')
        print(f'detections :: {detections}')
        print(f'front_point :: {front_point}')
        #personalNumber와 같은 라인의 글자 중 docId보다 아래에 있는 상자만 필터
        targetList = list(filter(lambda x : isRequireText(x, reference_point, width), detections))
        print(f'targetList :: {targetList}')
        logger.info(f'targetList :: {targetList}')
        
        
        response['license_number'] = personalNumber
        response['issued_date'] = ISSUE_DATE_REGEX.search(issueDate[0][1]).group().replace(".", "").replace(" ", "")
        response['issued_date'] = f"{response['issued_date'][:4]}.{response['issued_date'][4:6]}.{response['issued_date'][6:]}"
        

        print(f'targetList :: {len(targetList)}')

        if len(targetList) >= 3 :
            #Y축으로 위에서 아래로 정렬
            targetList = sorted(targetList, key=lambda x : x[0][0][1])
            
            # visaTypeIdx = 0
        
            # 처음 한글이 나오는 줄을 체류자격으로 판단한다.
            # for i, (position, text, ratio) in enumerate(targetList):
            #     if re.search("[가-힣]", text) is not None:
            #         visaTypeIdx = i
            #         break
                
            # if visaTypeIdx == 0:
            #     return RspIdentOcr(response_status="ERROR", response_message="Not Found visaType", result_values=str(textResult) ,plain_text=str(plain_text_list), result_path=param.image_path.replace('.jpg', '_afterOCR.jpg'))
            
            visaTypeIdx = len(targetList) - 1
            
            # 비자타입 앞의상자를 국적으로 판단
            nationality_item = targetList[visaTypeIdx - 1]
            
            # 구 외국인 등록증 중에 체류자격 글자가 커서 잡히는 경우가 있어서 
            # nationality_item 에 격이 포함되어 있으면 국적을 한 칸 더 앞으로 판단
            if '격' in nationality_item[1]:
                visaTypeIdx -= 1
                nationality_item = targetList[visaTypeIdx - 1]

            #nationality_item와 그 아래 글자 제거
            # targetList.remove(targetList[len(targetList)-2])
            # targetList.remove(targetList[len(targetList)-1])
            response['nationality'] = re.sub(r'[^A-Z]', '', nationality_item[1])
            
            # re.search("[가-힣]", text) 

            name = ' '.join([text for (position, text, ratio) in targetList[:visaTypeIdx-1]])
            name = re.sub("[가-힣]", '', name)
            name = re.sub("[-_]", '', name)
            name = re.sub("[-_]\s", '', name)
            name = name.strip()
            
            # for nameBox in targetList:
                # name = name + ' ' + nameBox[1]

            response['name'] = name
            if '(' in name:
                response['name'] = name.split('(')[0]
            
        response['result'] = True

        return response

    if type.upper() == 'RESIDENT':
        points_percentage = social_license_points_percentage
    elif type.upper() == 'DRIVER':
        points_percentage = drive_license_points_percentage
    
    for idx, reference_points in enumerate(points_percentage):
        reference_point_x = width * reference_points[0]
        reference_point_Y = height * reference_points[1]

        box = None;
        distance = sys.maxsize
        
        for text in texts:
            points = np.array(text["points"], dtype=np.int32)

            # 사각형의 중심 계산
            center_x = np.mean(points[:, 0]).astype(int)
            center_y = np.mean(points[:, 1]).astype(int)

            new_distance = (center_x - reference_point_x) ** 2 + (center_y - reference_point_Y) ** 2

            if distance > new_distance: 
                distance = new_distance
                box = text

        if box is not None:
            print(f'label[idx] :: {label[idx]}')
            print(f'box["text"] :: {box["text"]}')
            response[label[idx]] = box['text']
        else:
            return response
    
    print(f'text_analyze2 :: {response}')

    response['result'] = True
    return response


def isPersonalNumber(text):
    if isPersonalNumberFront(text) and isPersonalNumberBack(text):
        return True
    return False 

def isPersonalNumberFront(text):
    if FRONT_REGEX.search(text) is None:
        return False
    return True

def isPersonalNumberBack(text):
    if BACK_REGEX.search(text) is None:
        return False
    return True

def isIssueDate(text):
    if ISSUE_DATE_REGEX.search(text) is not None:
        return True
    return False

@observe_process_time
def isRequireText(detect_item, reference_point, width):
    # reference_point = (112.0, 225.0, 242) ## 외국인 번호 시작 지점, 외국인 번호 앞 자리 끝나는 지점, 외국인 번호 끝나는 Y 좌표
    start_x = reference_point[0]
    end_x = reference_point[1]
    start_y = reference_point[2]
    end_y = reference_point[3]
    
    minX = detect_item[0][0][0]
    maxX = detect_item[0][1][0]
    minY = detect_item[0][0][1]
    maxY = detect_item[0][3][1]
    
    # detect_item 의 maxX 가 start_x 보다 작은 경우
    if start_x > maxX:
        return False
    # detect_item 의 maxX 가 사진 95% 부분을 넘어갈 경우
    elif maxX > width * 0.95:
        return False
    # leftTop_point 의 leftTop_point[0] 가 start_y 보다 큰 경우
    elif minY < start_y:
        return False
    elif maxY > end_y:
        return False
    
    return True

def count_numbers(text):
    count = 0
    
    for char in text:
        if char.isdigit():
            count += 1
            
    return count
    
def find_first_number_index(text):
    idx = 0
    
    for char in text:
        if char.isdigit():
            return idx
        
        idx += 1
            
    return -1   
    
# item = [([[116, 208], [344, 208], [344, 240], [116, 240]], '860328-5141113', 0.979058456672269)]
def find_number_start(item):
    # a b
    # c d
    # 시작 지점의 x 좌표 item[0][0][0][0]
    start_x = item[0][0][0][0]
    # 끅 지점의 x 좌표 item[0][0][1][0]
    end_x = item[0][0][1][0]
    # 텍스트
    text = item[0][1]
    
    return start_x + (end_x - start_x) * ( find_first_number_index(text) / len(text) )
    
def find_reference_point(item):
    # 텍스트
    text = item[0][1]
    digit_count = count_numbers(text)
    
    if digit_count == 6:
        end_x = item[0][0][1][0]
    elif digit_count == 13:    
        end_x = (item[0][0][1][0] + item[0][0][0][0]) / 2
        
    # 외국인 번호 시작 지점, 외국인 번호 앞 자리 끝나는 지점, 외국인 번호 끝나는 Y 좌표
    return find_number_start(item), end_x, item[0][0][3][1]

    
async def faceDetect(img):
    global YUNET
    if YUNET is None:
        YUNET = create_Yunet()
    
    YUNET.setInputSize([320, 320])
    result = YUNET.infer(cv.resize(img, dsize=(320, 320)))
        #얼굴 위치 확인
    if result is None:
        return None
    faceStartX = int(result[0][0])
    print(f'faceStartX :: {faceStartX}')
    return faceStartX

def rectInnerCheck(rect, point):
    x, y = point
    if rect[0] <= x and rect[0]+rect[2] >= x and rect[1] <= y and rect[1]+rect[3] >= y:
        return True
    else :
        return False

#모든 이미지 동일하게
def chkMargin(cropRect, points):
    for point in points:
        if rectInnerCheck(cropRect, point=point) is False:
            logger.info(f'cropRect :: {cropRect}')
            logger.info(f'point :: {point}')
            return False

    return True

#가이드 버전용
def guideAlignCheck(guide_point, object_point, exeRatio):
    (guide_x, guide_y, guide_w, guide_h) = guide_point
    (x, y, w, h) = object_point
    (innerExeRatio, outterExeRatio) = exeRatio
    
    #x,y,w,h각 값이 가이드 x,y,w,h보다 innerExeRatio, outterExeRatio이상으로 벌어져 있는지 확인
    if guide_x > x+innerExeRatio or guide_x < x-outterExeRatio :
        return False
    elif guide_y > y+innerExeRatio or guide_y < y-outterExeRatio :
        return False
    elif guide_w < w-innerExeRatio or guide_w > w+outterExeRatio :
        return False
    elif guide_h < h-innerExeRatio or guide_h > h+outterExeRatio :
        return False
    return True
    

async def test(imgPath):
    
    r = asyn.create_task(DetectIdentification(ReqIDScan(image_path=imgPath, ocr_flag='Y')))
    
    k = await r

    print(r)
    print(k)
    # r = asyn.create_task(DetectIdentification(ReqIDScan(image_path="test_data/idtest/RESIDENT_001.jpg", ocr_flag='Y')))
    # k = await r


if __name__ == "__main__":
    logging.basicConfig(level=logging.DEBUG)
    #result = DetectIdentification(img_path="imgs/ocrTestSet/202401182210651_.jpg", y=700, h=521, sh=1920)
    #result = DetectIdentification(img_path="imgs/idcamTest/test1.jpg", y=196, h=211, sh=603)
    #result = DetectIdentification(img_path="imgs/idcamTest/test2.jpg", y=299, h=211, sh=808)
    #result = DetectIdentification(img_path="imgs/idcamTest/test3.jpg", y=259, h=236, sh=753)
    # asyn.run(test())

    valid_extensions = ('.jpg', '.jpeg', '.png', '.bmp', '.gif', '.tiff')
    base_dir = 'C:/Users/user/Desktop/OCR_detect_data/old_arc/'
    # base_dir = 'C:/projects/PyFR_Server/src/test_data/old_arc'

    asyn.run(test('test_data/RESIDENT_001.jpg'))

    # base_dir 내의 모든 파일과 디렉토리를 재귀적으로 탐색합니다.
    # for root, dirs, files in os.walk(base_dir):
    #     for file in files:
    #         if file.lower().endswith(valid_extensions):
    #             image_path = os.path.join(root, file)
    #             asyn.run(test(image_path))

    #             break;
    
    exit()
    
    # text_info = {}
    # text_info["personal_number"] = "927204-2842625"
    # text_info["name"] = "eeee" 
    # text_info["issue_date "] = "2017.02.24"
    
    # detect_info = DetectInfo(box={"x":11, "y":12, "w":12, "h":23}, id_type="ARC"
    #                         , text_info=text_info
    #                         , face_box={"x":11, "y":12, "w":12, "h":23}
    #                         , face_image_path=""
    #                         , id_image_path="C:/projects/FR_Spring/temp/ocrPath/2024071117/client001/20240711_PASSPORT_eb62fdb1.jpg"
    #                         , qr_data="eeee")
    
    # return RspAnalyzeText(detect_infos=detect_info, result_code="00", refer_no=param.refer_no, process_time=11)
    
if __name__ == "__main":
    print(f"__name__ :: {__name__}")
    </div>
    <div>
    package com.e9pay.vision.id.service.impl;

import java.io.File;
import java.text.SimpleDateFormat;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.Future;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.e9pay.vision.id.dao.IdDao;
import com.e9pay.vision.id.dto.TextAnalyzeReq;
import com.e9pay.vision.id.dto.TextAnalyzeRsp;
import com.e9pay.vision.id.dto.TextAnalyzeRsp.DetectInfo;
import com.e9pay.vision.id.dto.TextAnalyzeRsp.TextInfo;
import com.e9pay.vision.id.service.IdService;
import com.faceRecog.constant.enums.ServicePath;
import com.faceRecog.constant.prop.ApplicationConfigManager;
import com.faceRecog.service.impl.IdScanServiceImpl;
import com.faceRecog.util.FileUtil;
import com.faceRecog.util.HttpUtil;
import com.faceRecog.util.StringUtil;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class IdServiceImpl implements IdService {

	@Autowired
	private IdDao idDao;

	public String saveIdImg(MultipartFile file, String CSTMR_ID, String idType) throws Exception {
		log.info("saveMrz >>>> START");

		IdScanServiceImpl idScanService = new IdScanServiceImpl();

		final String newFileName = idScanService.generateFileName(idType);
		final String dateTime = new SimpleDateFormat("YYYYMMddHH").format(new Date());
		String SAVE_DIRECTORY = ServicePath.OCR_IMAGE_PATH.path + "/" + dateTime + "/";
		if (!StringUtil.getStr(CSTMR_ID).isEmpty()) {
			SAVE_DIRECTORY += CSTMR_ID + "/";
		}
		File DIRECTORY = new File(SAVE_DIRECTORY.replaceAll("\n", ""));
		if (!DIRECTORY.exists()) {
			DIRECTORY.mkdirs();
		}
		final String SAVE_PATH = FileUtil.saveFile(file, newFileName, SAVE_DIRECTORY);

		if (SAVE_PATH.isEmpty())
			throw new Exception("파일 저장에 실패했습니다.");

		log.info("saveMrz >>>> END");
		return SAVE_DIRECTORY + SAVE_PATH;
	}

	@Override
	public Map<String, Object> inquiryJson(TextAnalyzeReq req) throws Exception {
		long start = System.currentTimeMillis();

		MultipartFile imageFile = FileUtil.convertBase64ToMultipartFile(req.getImage_file(), req.getClient_id());

		String filePath = saveIdImg(imageFile, req.getClient_id(), "PASSPORT");

		// TODO : python 통신 (idScanController./ocr/v1/idScan)
		try {
			Map<String, Object> paramMap = new HashMap<>();
			paramMap.put("image_path", filePath);
			paramMap.put("refer_no", "qqq");
			paramMap.put("ocr_flag", "Y");
			log.info("paramMap = {}", paramMap);

			Future<ResponseEntity<String>> idScan_response = HttpUtil
					.sendPostAsync(ApplicationConfigManager.PYTHON.getURL("/ocr/v1/analyzeText"), paramMap);
			ResponseEntity<String> idScan_result = null;
			try {
				idScan_result = idScan_response.get();
			} catch (Exception e) {
				log.info("pyIdDetailScan Exception {}", e);
				// 통신 오류
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("1")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			String resBody = idScan_response.get().getBody();
			log.info("pyIdDetailScan idScanProcess result = {}", resBody);

			ObjectMapper om = new ObjectMapper();
			if (!HttpStatus.OK.equals(idScan_result.getStatusCode())) {
				log.info("pyIdDetailScan HttpStatus : {}", idScan_result.getStatusCode());
				// 통신 오류
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("2")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			Map<String, Object> idScanRspResultMap = new HashMap<String, Object>();
			try {
				idScanRspResultMap = om.readValue(resBody, new TypeReference<Map<String, Object>>() {
				});
			} catch (Exception e) {
				log.info("pyIdDetailScan Exception : {}", e);
				// 통신결과 파싱 오류
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("3")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			String result_code = StringUtil.getStr(idScanRspResultMap.get("result_code"));
			if (!"00".equals(result_code)) {
				log.info("pyIdDetailScan result_code :: {}", result_code);
				// 응답결과가 성공이 아닌 경우
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("4")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			String cropped_file_path = StringUtil.getStr(idScanRspResultMap.get("cropped_img_path"));
			log.info("pyIdDetailScan cropped_file_path load:: {}", cropped_file_path);
			String cropped_file_String = "";
			try {
				cropped_file_String = FileUtil.imageToBase64(cropped_file_path);
			} catch (Exception e) {
				log.info("pyIdDetailScan Exception {}", e);
				// 이미지 base64인코딩 오류
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("5")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			String jsonString = (String) idScanRspResultMap.get("ocr_data");
			ObjectMapper objectMapper = new ObjectMapper();
			Map<String, Object> ocr_data = objectMapper.readValue(jsonString, Map.class);

			String qrCodeYn = StringUtil.getStr(idScanRspResultMap.get("qr_code_yn"));
			log.info("pyIdDetailScan SUCCESS");
			String task_id = idDao.getTaskId();
			TextInfo textInfo = TextInfo.builder().personal_number((String) (ocr_data.get("license_number")))
					.name((String) (ocr_data.get("name"))).issue_date((String) (ocr_data.get("issued_date")))
					.docType((String) (ocr_data.get("id_type"))).nationality((String) (ocr_data.get("nationality")))
					.build();

			DetectInfo detectInfo = DetectInfo.builder().number(1).id_type((String) (ocr_data.get("id_type")))
					.text_info(textInfo).qr_code(qrCodeYn).id_image(cropped_file_String).build();

			List<DetectInfo> detectInfos = Arrays.asList(detectInfo);

			DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyyMMddHHmmss");
			String nowTime = LocalDateTime.now().format(formatter);

			idDao.insertData(task_id, req.getClient_id(), filePath, objectMapper.writeValueAsString(detectInfo),
					req.getPerson_id(), TextAnalyzeRsp.ResponseMessage.SUCCESS.result_code,
					TextAnalyzeRsp.ResponseMessage.SUCCESS.result_message, nowTime, req.getPerson_id(), nowTime,
					req.getPerson_id());

			TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(task_id).refer_no(req.getPerson_id())
					.result_code(TextAnalyzeRsp.ResponseMessage.SUCCESS.result_code)
					.result_message(TextAnalyzeRsp.ResponseMessage.SUCCESS.result_message).detect_infos(detectInfos)
					.process_time(System.currentTimeMillis() - start).build();

			Map<String, Object> resultMap = new HashMap<>();
			resultMap.put("rsp", rsp);

			return resultMap;
		} catch (Exception e) {
			log.info("Exception ee : {}", e);
			TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("6")
					.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
					.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
					.process_time(System.currentTimeMillis() - start).build();

			Map<String, Object> resultMap = new HashMap<>();
			resultMap.put("rsp", rsp);
			return resultMap;
		}
	}

	@Override
	public Map<String, Object> inquiryMultipart(TextAnalyzeReq req, MultipartFile imageFile) throws Exception {
		// TODO IdScanServiceImpl.saveIdImg() 참조
//		byte[] imageBytes = imageFile.getBytes();
//		String fileName = imageFile.getOriginalFilename();
//		String filePath = ServicePath.OCR_IMAGE_PATH.path + fileName;
//		File file = new File(filePath);
//		file.getParentFile().mkdirs();
//
//		try (FileOutputStream fos = new FileOutputStream(file)) {
//			fos.write(imageBytes);
//		}
		long start = System.currentTimeMillis();

		String filePath = saveIdImg(imageFile, req.getClient_id(), "PASSPORT");

		// TODO : python 통신 (idScanController./ocr/v1/idScan)
		try {
			Map<String, Object> paramMap = new HashMap<>();
			paramMap.put("image_path", filePath);
			paramMap.put("refer_no", req.getPerson_id());
			paramMap.put("ocr_flag", "Y");
			log.info("paramMap = {}", paramMap);

			Future<ResponseEntity<String>> idScan_response = HttpUtil
					.sendPostAsync(ApplicationConfigManager.PYTHON.getURL("/ocr/v1/analyzeText"), paramMap);
			ResponseEntity<String> idScan_result = null;
			try {
				idScan_result = idScan_response.get();
			} catch (Exception e) {
				log.info("pyIdDetailScan Exception {}", e);
				// 통신 오류
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("1")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			String resBody = idScan_response.get().getBody();
			log.info("pyIdDetailScan idScanProcess result = {}", resBody);

			ObjectMapper om = new ObjectMapper();
			if (!HttpStatus.OK.equals(idScan_result.getStatusCode())) {
				log.info("pyIdDetailScan HttpStatus : {}", idScan_result.getStatusCode());
				// 통신 오류
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("2")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			Map<String, Object> idScanRspResultMap = new HashMap<String, Object>();
			try {
				idScanRspResultMap = om.readValue(resBody, new TypeReference<Map<String, Object>>() {
				});
			} catch (Exception e) {
				log.info("pyIdDetailScan Exception : {}", e);
				// 통신결과 파싱 오류
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("3")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			String result_code = StringUtil.getStr(idScanRspResultMap.get("result_code"));
			if (!"00".equals(result_code)) {
				log.info("pyIdDetailScan result_code :: {}", result_code);
				// 응답결과가 성공이 아닌 경우
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("4")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}
			String cropped_file_path = StringUtil.getStr(idScanRspResultMap.get("cropped_img_path"));
			String cropped_file_String = "";
			try {
				cropped_file_String = FileUtil.imageToBase64(cropped_file_path);
			} catch (Exception e) {
				log.info("pyIdDetailScan Exception {}", e);
				// 이미지 base64인코딩 오류
				TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("5")
						.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
						.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
						.process_time(System.currentTimeMillis() - start).build();

				Map<String, Object> resultMap = new HashMap<>();
				resultMap.put("rsp", rsp);
				return resultMap;
			}

			String jsonString = (String) idScanRspResultMap.get("ocr_data");
			ObjectMapper objectMapper = new ObjectMapper();
			Map<String, Object> ocr_data = objectMapper.readValue(jsonString, Map.class);

			String qrCodeYn = StringUtil.getStr(idScanRspResultMap.get("qr_code_yn"));
			log.info("pyIdDetailScan SUCCESS");
			String task_id = idDao.getTaskId();
			TextInfo textInfo = TextInfo.builder().personal_number((String) (ocr_data.get("license_number")))
					.name((String) (ocr_data.get("name"))).issue_date((String) (ocr_data.get("issued_date")))
					.docType((String) (ocr_data.get("id_type"))).nationality((String) (ocr_data.get("nationality")))
					.build();

			DetectInfo detectInfo = DetectInfo.builder().number(1).id_type((String) (ocr_data.get("id_type")))
					.text_info(textInfo).qr_code(qrCodeYn).id_image(cropped_file_String).build();

			List<DetectInfo> detectInfos = Arrays.asList(detectInfo);

			DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyyMMddHHmmss");
			String nowTime = LocalDateTime.now().format(formatter);

			idDao.insertData(task_id, req.getClient_id(), filePath, objectMapper.writeValueAsString(detectInfo),
					req.getPerson_id(), TextAnalyzeRsp.ResponseMessage.SUCCESS.result_code,
					TextAnalyzeRsp.ResponseMessage.SUCCESS.result_message, nowTime, req.getPerson_id(), nowTime,
					req.getPerson_id());

			TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(task_id).refer_no(req.getPerson_id())
					.result_code(TextAnalyzeRsp.ResponseMessage.SUCCESS.result_code)
					.result_message(TextAnalyzeRsp.ResponseMessage.SUCCESS.result_message).detect_infos(detectInfos)
					.process_time(System.currentTimeMillis() - start).build();

			Map<String, Object> resultMap = new HashMap<>();
			resultMap.put("rsp", rsp);    

			return resultMap;
		} catch (Exception e) {
			log.info("Exception ee : {}", e);
			TextAnalyzeRsp rsp = TextAnalyzeRsp.builder().task_id(null).refer_no("6")
					.result_code(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_code)
					.result_message(TextAnalyzeRsp.ResponseMessage.ERROR_FAIL.result_message).detect_infos(null)
					.process_time(System.currentTimeMillis() - start).build();

			Map<String, Object> resultMap = new HashMap<>();
			resultMap.put("rsp", rsp);
			return resultMap;
		}

		// TODO : IdScanServiceImpl.idScanPreprocess 참조해서 fastAPI 통신

	}

}

    </div>
	<div>
 package com.e9pay.vision.id.api;

import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.e9pay.vision.id.dto.TextAnalyzeReq;
import com.e9pay.vision.id.dto.TextAnalyzeRsp;
import com.e9pay.vision.id.service.IdService;
import com.fasterxml.jackson.databind.ObjectMapper;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@RestController
public class IDController {

	@Autowired
	private IdService idService;

//	@RequestMapping(value = "/test/hikorea")
//	public ResponseEntity<HiKoreaInquiryRsp>  hikorea(HiKoreaInquiryReq req) throws Exception {
//		return ResponseEntity.ok().body(hiKoreaService.hiKoreaInquiry(req));
//	}

	// TODO : /ocr/v1/analyze, POST 받을 수 있게 컨트롤러 추가
	@RequestMapping(value = "/ocr/v1/analyze", method = RequestMethod.POST, consumes = "multipart/form-data")
	public ResponseEntity<TextAnalyzeRsp> textAnalyze(@ModelAttribute TextAnalyzeReq req,
			@RequestPart("image") MultipartFile imageFile) throws Exception {
		log.info("req :: {}", req);
		log.info("file :: {}", imageFile);
		req.setOption(new ObjectMapper().readValue(req.getOptions(), TextAnalyzeReq.Options.class));
		log.info("req :: {}", req);

		return ResponseEntity.ok().body((TextAnalyzeRsp) idService.inquiryMultipart(req, imageFile).get("rsp"));
	}

	@RequestMapping(value = "/ocr/v1/analyze", method = RequestMethod.POST, consumes = "application/json")
	public ResponseEntity<TextAnalyzeRsp> textAnalyzeBase64(@RequestBody TextAnalyzeReq req) throws Exception {
		log.info("req :: {}", req);
		
		
		
		return ResponseEntity.ok().body((TextAnalyzeRsp) idService.inquiryJson(req).get("rsp"));
	}
	// TODO : content-type : multipart-form/data 또는 application/json 받을 수 있도록 구현

}

 
 </div>
